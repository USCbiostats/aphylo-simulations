---
title: "Joint likelihood using fully and partially annotated trees"
author: "George G Vega Yon"
date: "Sep 26, 2019"
output:
  beamer_presentation:
    keep_tex: true
header-includes:
  - \usepackage{booktabs}
  - \usepackage{tabularx}
  - \usepackage{geometry}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.height=7)
library(aphylo)
library(xtable)
```

## Estimates

```{r read-data}
files <- list.files(pattern = "parameter_estimates_(mcmc|mle).+prior\\.rds", full.names = FALSE)
estimates <- lapply(files, readRDS)
```

```{r coef, results='asis', cache = TRUE, dependson=-1}
theta <- do.call(cbind, lapply(estimates, coef))
vars  <- do.call(cbind, lapply(lapply(estimates, vcov), diag))

tab  <- matrix(sprintf("%.2f", theta), ncol = ncol(theta))
dimnames(tab) <- list(rownames(theta), paste0("(", 1:ncol(tab), ")"))

varnames <- c(
  psi0  = "$\\psi_0$",
  psi1  = "$\\psi_1$",
  mu_d0 = "$\\mu_{d0}$",
  mu_d1 = "$\\mu_{d1}$",
  mu_s0 = "$\\mu_{s0}$",
  mu_s1 = "$\\mu_{s1}$",
  Pi    = "$\\pi$"
  )

rownames(tab) <- varnames[rownames(tab)]

# Adding information

ps <- lapply(estimates, prediction_score, loo=TRUE)
aucs <- sapply(ps, function(i) {
  mean(sapply(i, function(j) j$auc$auc))
})

aucs_med <- sapply(ps, function(i) {
  quantile(sapply(i, function(j) j$auc$auc), .5)
})
pss  <- sapply(ps, function(i) {
  tmp <- 1 - t(sapply(i, function(j) with(j, c(obs, random)/worse)))
  colMeans(tmp, na.rm = TRUE)
})


tab <- rbind(
  tab,
  `Tree count` = sapply(estimates, Ntrees),
  Method       = ifelse(grepl("mcmc", files), "MCMC", "MLE"),
  Prior        = ifelse(grepl("no_prior", files), "Uniform", "Beta"),
  Inferred     = ifelse(grepl("fully", files), "Yes", "No"),
  `AUC (mean)` = sprintf("%.2f", aucs),
  `AUC (median)` = sprintf("%.2f", aucs_med),
  `P. Score (obs)` = sprintf("%.2f", pss[1,]),
  `P. Score (random)` = sprintf("%.2f", pss[2,])
  )

tmptab <- tempfile()
tab <- xtable(tab, caption = paste0(
  "Parameter estimates using different estimation methods, priors, and ",
  "types of annotations."
  ))
print(tab, file = tmptab, booktabs = TRUE, scalebox = .6, 
      comment = FALSE, sanitize.text.function= function(i) i)
tab <- readLines(tmptab)
tab[grepl("begin\\{tabular", tab)] <- sprintf(
  "\\begin{tabular}{l*{%d}{m{%.2f\\linewidth}}}",
  ncol(theta),
  1.1/ncol(theta)
)
tab[grepl("Method", tab)] <- paste("\\midrule", tab[grepl("Method", tab)])

cat(tab, sep="\n")
```

## MCMC convergence: Fully annotated (Unif prior)

```{r preparing-for-mcmc-diagnostics}
files <- gsub("(parameter_estimates_)", "", files)
files <- gsub("(mcmc|mle)", "\\U\\1", files, perl = TRUE)
files <- gsub("_", " ", files)
files <- gsub("[.]rds", "", files)
names(estimates) <- files

# Getting the 4 smallest trees
inferred <- order(Ntip(estimates$`MCMC fully annotated no prior`))[1:4]
observed <- order(Ntip(estimates$`MCMC partially annotated no prior`))[1:4]
```


```{r setting-coda}
library(coda)
traceplot2 <- function(x, ylim = c(0,1), what = NULL) {
  x <- x$hist
  
  if (!is.null(what))
    x <- what(x)
  
  k <- ifelse(is.mcmc.list(x), ncol(x[[1]]), ncol(x))
  op <- par(mfrow = c(4,2), mai = c(0.3366, 0.2706, 0.2706, 0))
  traceplot(x, ylim = ylim)
  par(op)
}

```


```{r trace-fully-unif}
traceplot2(estimates$`MCMC fully annotated no prior`)
```

## MCMC convergence: Fully annotated (Beta prior)

```{r trace-fully-beta}
traceplot2(estimates$`MCMC fully annotated prior`)
```

## MCMC convergence: Partially annotated (Unif prior)

```{r trace-partially-unif}
traceplot2(estimates$`MCMC partially annotated no prior`)
```

## MCMC convergence: Partially annotated (Beta prior)

```{r trace-partially-beta}
traceplot2(estimates$`MCMC partially annotated prior`)
```

---

Zooming in Partially annotated trees model with Beta prior:

```{r}
traceplot2(estimates$`MCMC partially annotated prior`, ylim=NULL,
           what = function(i) window(i, 2000))
```


## How priors affect predictions: Fully annotated (Unif prior)

```{r annotations1.1}
plot(estimates$`MCMC fully annotated no prior`, which.tree = inferred[2],
     cex = .5, loo = TRUE, node.type.col = c("darkgreen", "darkgray"))
```

## How priors affect predictions: Fully annotated (Beta prior)

```{r annotations1.2}
plot(estimates$`MCMC fully annotated prior`, which.tree = inferred[2],
     cex = .5, loo = TRUE, node.type.col = c("darkgreen", "darkgray"))
```


## How priors affect predictions: Experimentally annotated (Unif prior)

```{r annotations2.1}
plot(estimates$`MCMC partially annotated no prior`, which.tree = observed[2],
     cex = .5, loo = TRUE, node.type.col = c("darkgreen", "darkgray"))
```


## How priors affect predictions: Experimentally annotated (Beta prior)

```{r annotations2.2}
plot(estimates$`MCMC partially annotated prior`, which.tree = observed[2],
     cex = .5, loo = TRUE, node.type.col = c("darkgreen", "darkgray"))
```


## Joint on one at a time?

```{r comparing-accuracy, eval=TRUE, echo=FALSE, fig.width=6, fig.height=6, out.width=".7\\linewidth"}

# Disjoint
estimates_disjoint <- readRDS("one-tree-at-a-time.rds")

aucs_dj <- sapply(estimates_disjoint, function(i) {
  aphylo::auc(i$predicted, i$expected)$auc
})

pss_dj  <- sapply(estimates_disjoint, function(i) {
  with(i, c(obs, random)/worse)
})

# Joint
ps_j <- ps[names(estimates) == "MCMC partially annotated prior"][[1]]
aucs_j <- sapply(ps_j, function(i) {i$auc$auc})
pss_j  <- sapply(ps_j, function(i) {
  1 - with(i, c(obs, random)/worse)
})

saveRDS(list(joint = aucs_j, disjoint = aucs_dj),
        file = "aucs.rds")

ttest <- t.test(aucs_j, aucs_dj, paired = TRUE)

dat <- rbind(
  data.frame(AUC = aucs_j, Model = "Pooled"),
  data.frame(AUC = aucs_dj, Model = "One-at-a-time")
)
library(ggplot2, quietly = TRUE)
ggplot(dat, aes(y = AUC, x = Model)) +
  geom_boxplot() + 
  labs(x = "Estimation method") + 
  annotate(
    "text",
    x     = 2,
    y     = 0,
    label = with(
      ttest,
      sprintf("Paired t-test 95%% CI [%.2f, %.2f]", conf.int[1], conf.int[2])
      )
    )
```


---

```{r out-of-sample1, fig.height=9.5}
# http://sifter.berkeley.edu/results-id=6810550
tree <- readRDS("PTHR11409.rds")

aucs <- lapply(1:3, function(i) aphylo::auc(tree$tip.annotation[,i+3], tree$tip.annotation[,i] ))

tree$tree$edge.length <- sqrt(tree$tree$edge.length)

plot(
  tree,
  main = sprintf("Adenosine Deaminase (PTHR11409)\nAUCs:={%.2f, %.2f, -}", aucs[[1]]$auc, aucs[[2]]$auc),
  cex = .15, prop = .25, align.tip.label=TRUE, node.type.col = c("darkgreen", "darkgray"))
```
